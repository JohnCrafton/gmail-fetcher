# Multi-stage build for secure, minimal Gmail Fetcher container
# Stage 1: Builder - Install dependencies
FROM python:3.11-slim as builder

WORKDIR /build

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# Stage 2: Runtime - Distroless Python image
FROM gcr.io/distroless/python3-debian12:nonroot

# Set working directory
WORKDIR /app

# Copy Python dependencies from builder
COPY --from=builder /root/.local /home/nonroot/.local

# Copy application code
COPY --chown=nonroot:nonroot src/ /app/src/
COPY --chown=nonroot:nonroot gmail-fetcher.py /app/

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PATH=/home/nonroot/.local/bin:$PATH \
    DATA_DIR=/data

# Create data directory with correct permissions
# Note: This needs to be mounted as a volume
USER nonroot

# Default data directory will be mounted here
VOLUME ["/data"]

# Labels for container metadata
LABEL org.opencontainers.image.title="Gmail Fetcher" \
      org.opencontainers.image.description="Secure local Gmail archiving solution" \
      org.opencontainers.image.authors="Built with Claude Code" \
      org.opencontainers.image.source="https://github.com/anthropics/claude-code" \
      org.opencontainers.image.vendor="Local" \
      org.opencontainers.image.licenses="MIT" \
      security.non-root="true" \
      security.distroless="true"

# Health check (distroless uses /usr/bin/python3)
# Note: distroless doesn't have shell, so health checks are limited
# We'll handle this in docker-compose with command checks

# Entry point
ENTRYPOINT ["/usr/bin/python3", "/app/gmail-fetcher.py"]

# Default command (can be overridden)
CMD []
